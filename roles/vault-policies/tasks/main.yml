---
# Load root token from file if not set (for standalone policies run)
- name: Check if root token file exists
  stat:
    path: "{{ vault_root_token_file }}"
  register: root_token_file_stat
  delegate_to: localhost

- name: Read root token from file
  slurp:
    src: "{{ vault_root_token_file }}"
  register: root_token_content
  delegate_to: localhost
  when: root_token_file_stat.stat.exists | default(false)

- name: Set root token from file
  set_fact:
    vault_root_token: "{{ root_token_content.content | b64decode | trim }}"
  when: root_token_content is defined and root_token_content.content is defined

- name: Fail when root token not available
  fail:
    msg: |
      Root token required for policy management. Set vault_root_token or ensure {{ vault_root_token_file }} exists (run init first).
  when: vault_root_token is not defined or vault_root_token == ""

# Resolve policies directory (support both relative and absolute)
- name: Resolve policies source directory
  set_fact:
    _policies_dir: "{{ vault_policies_source_dir | expanduser }}"
  when: vault_policies_source_dir is defined

# List policy files from directory (.hcl only)
- name: Find policy files in directory
  find:
    path: "{{ _policies_dir }}"
    patterns: "*.hcl"
    recurse: false
  register: policy_files
  delegate_to: localhost
  when:
    - _policies_dir is defined
    - vault_policies_source_dir is defined

# Create policies from vault_default_policies (inline)
- name: Create or update policy from default (inline)
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl/{{ item.name }}"
    method: POST
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body_format: json
    body:
      policy: "{{ item.content }}"
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
    status_code: [200, 204]
  loop: "{{ vault_default_policies | default([]) }}"
  when:
    - vault_policies_create_default | default(true)
    - vault_default_policies is defined
    - vault_default_policies | length > 0
    - vault_root_token is defined

- name: Create or update policy from custom (inline)
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl/{{ item.name }}"
    method: POST
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body_format: json
    body:
      policy: "{{ item.content }}"
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
    status_code: [200, 204]
  loop: "{{ vault_custom_policies | default([]) }}"
  when:
    - vault_custom_policies is defined
    - vault_custom_policies | length > 0
    - vault_root_token is defined

# Create policies from files in policies/ directory
- name: Read policy file content
  slurp:
    src: "{{ item.path }}"
  register: policy_file_content
  delegate_to: localhost
  loop: "{{ policy_files.files | default([]) }}"
  when:
    - policy_files is defined
    - policy_files.files is defined
    - policy_files.files | length > 0
  loop_control:
    label: "{{ item.path | basename }}"

- name: Create or update policy from file
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl/{{ (item.item.path | basename) | regex_replace('\\.hcl$', '') }}"
    method: POST
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body_format: json
    body:
      policy: "{{ item.content | b64decode }}"
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
    status_code: [200, 204]
  loop: "{{ policy_file_content.results | default([]) }}"
  when:
    - policy_file_content is defined
    - policy_file_content.results is defined
    - item.skipped is not defined or not item.skipped
    - item.content is defined
    - vault_root_token is defined
  loop_control:
    label: "{{ (item.item.path | basename) | regex_replace('\\.hcl$', '') }}"
