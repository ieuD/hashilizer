---
# Load root token from file if not set (e.g. when role run without playbook pre_tasks)
- name: Check if root token file exists
  stat:
    path: "{{ vault_root_token_file }}"
  register: root_token_file_stat
  delegate_to: localhost

- name: Read root token from file
  slurp:
    src: "{{ vault_root_token_file }}"
  register: root_token_content
  delegate_to: localhost
  no_log: true
  when: root_token_file_stat.stat.exists | default(false)

- name: Set root token from file
  set_fact:
    vault_root_token: "{{ root_token_content.content | b64decode | trim }}"
  no_log: true
  when: root_token_content is defined and root_token_content.content is defined

- name: Fail when root token not available
  fail:
    msg: "Root token required. Set vault_root_token or ensure {{ vault_root_token_file }} exists (run init first)."
  when: vault_root_token is not defined or vault_root_token == ""

# Resolve use_all flag from host/group vars (so role sees group_vars value)
- name: Resolve policies use_all flag
  set_fact:
    _vault_policies_use_all: "{{ hostvars[inventory_hostname]['vault_policies_use_all'] | default(vault_policies_use_all | default(false)) }}"

# Resolve policies directory
- name: Resolve policies source directory
  set_fact:
    _policies_dir: "{{ vault_policies_source_dir | expanduser }}"
  when: vault_policies_source_dir is defined

# --- When vault_policies_use_all: true — include all .hcl files under policies folder
- name: Find all .hcl policy files in policies folder
  find:
    path: "{{ _policies_dir }}"
    patterns: "*.hcl"
    recurse: false
  register: all_policy_files
  delegate_to: localhost
  when:
    - _policies_dir is defined
    - _vault_policies_use_all | default(false)

- name: Read all policy files from policies folder
  slurp:
    src: "{{ item.path }}"
  register: all_policy_content
  delegate_to: localhost
  loop: "{{ all_policy_files.files | default([]) }}"
  when:
    - _vault_policies_use_all | default(false)
    - all_policy_files is defined
    - all_policy_files.files is defined
    - all_policy_files.files | length > 0
  loop_control:
    label: "{{ item.path | basename }}"

- name: Create or update policy in Vault from policies folder (use_all)
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl/{{ (item.item.path | basename) | regex_replace('\\.hcl$', '') }}"
    method: POST
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body_format: json
    body:
      policy: "{{ item.content | b64decode }}"
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
    status_code: [200, 204]
  loop: "{{ all_policy_content.results | default([]) }}"
  no_log: true
  when:
    - _vault_policies_use_all | default(false)
    - all_policy_content is defined
    - all_policy_content.results is defined
    - not (item.skipped | default(false))
    - item.content is defined
    - vault_root_token is defined
  loop_control:
    label: "{{ (item.item.path | basename) | regex_replace('\\.hcl$', '') }}"

# --- When vault_policies_use_all: false — use vault_default_policies list (filenames) looked up under policies folder
- name: Check which policy files exist (from vault_default_policies list)
  stat:
    path: "{{ _policies_dir }}/{{ item }}"
  register: policy_file_stat
  delegate_to: localhost
  loop: "{{ vault_default_policies | default([]) }}"
  when:
    - _policies_dir is defined
    - not (_vault_policies_use_all | default(false))
    - vault_default_policies is defined
    - vault_default_policies | length > 0
  loop_control:
    label: "{{ item }}"

- name: Read policy file from policies folder (from list)
  slurp:
    src: "{{ _policies_dir }}/{{ item.item }}"
  register: policy_file_content
  delegate_to: localhost
  loop: "{{ policy_file_stat.results | default([]) }}"
  when:
    - not (_vault_policies_use_all | default(false))
    - policy_file_stat is defined
    - policy_file_stat.results is defined
    - not (item.skipped | default(false))
    - item.stat is defined
    - item.stat.exists | default(false)
  loop_control:
    label: "{{ item.item }}"

- name: Create or update policy in Vault from policies folder (from list)
  uri:
    url: "{{ vault_addr }}/v1/sys/policies/acl/{{ _policy_name }}"
    method: POST
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body_format: json
    body:
      policy: "{{ item.content | b64decode }}"
    validate_certs: "{{ not vault_skip_verify | default(true) }}"
    status_code: [200, 204]
  loop: "{{ policy_file_content.results | default([]) }}"
  no_log: true
  when:
    - not (_vault_policies_use_all | default(false))
    - policy_file_content is defined
    - policy_file_content.results is defined
    - not (item.skipped | default(false))
    - item.content is defined
    - vault_root_token is defined
  vars:
    _policy_name: "{{ (item.item.item) | regex_replace('\\.hcl$', '') }}"
  loop_control:
    label: "{{ _policy_name }}"
