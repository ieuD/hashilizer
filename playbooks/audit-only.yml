---
# Playbook for audit configuration only
- name: Configure Vault Audit Logging
  hosts: vault_servers
  gather_facts: yes
  become: no
  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"

  pre_tasks:
    - name: Check if root token file exists
      stat:
        path: "{{ vault_root_token_file }}"
      register: _audit_root_token_file_stat
      delegate_to: localhost

    - name: Read root token from file
      slurp:
        src: "{{ vault_root_token_file }}"
      register: _audit_root_token_content
      delegate_to: localhost
      no_log: true
      when: _audit_root_token_file_stat.stat.exists | default(false)

    - name: Set root token from file
      set_fact:
        vault_root_token: "{{ _audit_root_token_content.content | b64decode | trim }}"
      no_log: true
      when: _audit_root_token_content is defined and _audit_root_token_content.content is defined

    - name: Check for root token
      fail:
        msg: "Root token is required. Set vault_root_token or ensure {{ vault_root_token_file }} exists (run init first)."
      when: vault_root_token is not defined or vault_root_token == ""

  roles:
    - role: vault-audit

  post_tasks:
    - name: Display audit configuration summary
      debug:
        msg: |
          Vault Audit Configuration Complete!

          Audit Devices: {{ vault_audit_devices | map(attribute='path') | list }}
          Log Directory: {{ vault_audit_log_dir }}

          You can view audit logs at the configured paths.
