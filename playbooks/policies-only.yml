---
# Playbook for policy management only
- name: Configure Vault Policies
  hosts: vault_servers
  gather_facts: yes
  become: no
  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"

  pre_tasks:
    - name: Check if root token file exists
      stat:
        path: "{{ vault_root_token_file }}"
      register: _root_token_file_stat
      delegate_to: localhost

    - name: Read root token from file
      slurp:
        src: "{{ vault_root_token_file }}"
      register: _root_token_content
      delegate_to: localhost
      when: _root_token_file_stat.stat.exists | default(false)

    - name: Set root token from file
      set_fact:
        vault_root_token: "{{ _root_token_content.content | b64decode | trim }}"
      when: _root_token_content is defined and _root_token_content.content is defined

    - name: Check for root token
      fail:
        msg: "Root token is required. Set vault_root_token or ensure {{ vault_root_token_file }} exists (run init first)."
      when: vault_root_token is not defined or vault_root_token == ""

  roles:
    - role: vault-policies

  post_tasks:
    - name: Display policy configuration summary
      debug:
        msg: |
          Vault Policy Configuration Complete!

          Policies Directory: {{ vault_policies_source_dir }}
          Default Policies: {{ vault_default_policies | map(attribute='name') | list }}
          Custom Policies: {{ vault_custom_policies | default([]) | map(attribute='name') | list }}

          Use 'vault policy list' to see all policies.
